---
title: Run Omni on Kubernetes
description: Run Omni on your Kubernetes infrastructure
---

import { omni_release } from '/snippets/custom-variables.mdx';

This guide shows you how to run Omni on Kubernetes. This guide assumes that Omni will be deployed on a Kubernetes cluster with 1 controlplane and 1 worker node. Small differences should be expected when using different components.

For SAML integration sections, this guide assumes Azure AD will be the provider for SAML.

Omni is available via a [Business Source License](https://github.com/siderolabs/omni/blob/main/LICENSE) which allows free installations in non-production environments. If you would like to deploy Omni for production use please contact [Sidero sales](mailto:sales@siderolabs.com?subject=Omni%20license%20inquiry\&body=Hello,%20I%20would%20like%20to%20purchase%20an%20on-prem%20license%20for%20Omni.). If you would like to subscribe to the hosted version of Omni please see the [SaaS pricing](https://www.siderolabs.com/pricing/);

## Prerequisites

There are several prerequisites for deploying Omni on Kubernetes. We will assume you have an Kubernetes cluster available with a CNI and CSI plugin installed.

### Certificates

We need to have a component that will manage SSL certificates for Omni. In this example, we are using cert-manager. You can install cert-manager with `kubectl apply` or `helm install`.

```bash
# Kubectl
## Create the cert-manager namespace
kubectl create namespace cert-manager

## Install cert-manager
kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.19.2/cert-manager.yaml
```
```bash
# Helm
helm install \
  cert-manager oci://quay.io/jetstack/charts/cert-manager \
  --version v1.19.2 \
  --namespace cert-manager \
  --create-namespace \
  --set crds.enabled=true \
  --set global.leaderElection.namespace=cert-manager \
  --set enableCertificateOwnerRef=true \
  --set "extraArgs[0]=--dns01-recursive-nameservers-only" \
  --set-string "extraArgs[1]=--dns01-recursive-nameservers=1.1.1.1:53\,8.8.8.8:53"
```
#### Issuers

We also need to have issuers in order to request certificates. These can be a `Issuer` or a `ClusterIssuer`. In this example we're using [DNS Challenge with CloudFlare](https://cert-manager.io/docs/configuration/acme/dns01/cloudflare/) and a `ClusterIssuer`.

```bash
cat <<'EOF' | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: cloudflare-api-token
  namespace: cert-manager
type: Opaque
stringData:
  api-token: <Cloudflare API token>
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt
spec:
  acme:
    email: <Your Email>
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: cluster-issuer-account-key
    solvers:
    - dns01:
        cloudflare:
          email: <Your Email>
          apiTokenSecretRef:
            name: cloudflare-api-token
            key: api-token
EOF
```

### LoadBalancer (optional)
If you want to expose Omni with a LoadBalancer service, you will need to have a LoadBalancer available in your cluster. If you do not have a LoadBalancer available, you can still expose Omni with an Ingress and a NodePort service.

In this example, we are using [MetalLB](https://metallb.universe.tf/) as a LoadBalancer in on-prem Kubernetes clusters. You can install MetalLB with `kubectl apply` or `helm install`.

```bash
# Kubectl
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.15.3/config/manifests/metallb-native.yaml
```
```bash
# Helm
helm repo add metallb https://metallb.github.io/metallb --force-update
helm install \
  metallb metallb/metallb \
  --version v0.15.3 \
  --namespace metallb-system \
  --create-namespace
```

We also need to configure an address pool and a L2 advertisement for MetalLB to use. This can be done with the following manifest:

```bash
cat <<'EOF' | kubectl apply -f -
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: metallb-ip-pool
  namespace: metallb-system
spec:
  addresses:
  - 10.10.75.5-10.10.75.5
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: example
  namespace: metallb-system
EOF
```

<Note>If you used Helm to install MetalLB and are running a Kubernetes version that enforces Pod Security Admission Policies, the namespace for MetalLB must be labeled to allow privileged containers. Click [here](https://metallb.universe.tf/installation/#installation-with-helm). for more info.</Note>

### Ingress Controller
You will also need to have an ingress controller installed in your cluster. In this example, we are using [Traefik](https://traefik.io/traefik/), but any ingress controller should work.

```bash
# Helm
helm repo add traefik https://helm.traefik.io/traefik --force-update
helm install \
  traefik traefik/traefik \
  --version 39.0.1 \
  --namespace traefik \
  --create-namespace \
  --set ingressClass.enabled=true
```

## Configure authentication

### Auth0

Create an [Auth0 account](https://auth0.com/signup).

On the account level, configure "Authentication - Social" to allow GitHub and Google login.

Create an Auth0 application of the type "single page web application".

Configure the Auth0 application with the following:

* Allowed callback URLs: `https://<domain name for omni on k8s>`
* Allowed web origins: `https://<domain name for omni on k8s>`
* Allowed logout URLs: `https://<domain name for omni on k8s>`

Disable username/password auth on "Authentication - Database - Applications" tab.

Enable GitHub and Google login on the "Authentication - Social" tab.

Enable email access in the GitHub settings.

Take note of the following information from the Auth0 application:

* Domain
* Client ID

### SAML Identity Providers

Other identity providers also work with Omni. Configuring these should be similar to Auth0.

* [EntraID/Azure AD](../security-and-authentication/using-saml-with-omni/how-to-configure-entraid-for-omni)
* [Keycloak](./configure-keycloak-for-omni)
* [Okta](../security-and-authentication/using-saml-with-omni/configure-okta-for-omni)
* [Workspace ONE Access](../security-and-authentication/using-saml-with-omni/configure-workspace-one-access-for-omni)
* [Unifi Identity Enterprise](../security-and-authentication/using-saml-with-omni/configure-unifi-identity-enterprise-for-omni)

## Omni

### Create etcd encryption key

Generate a GPG key:

```bash
gpg --quick-generate-key "Omni (Used for etcd data encryption) how-to-guide@siderolabs.com" rsa4096 cert never
```

Find the fingerprint of the generated key:

```bash
gpg --list-secret-keys
```

Using the fingerprint, add an encryption subkey and export:

```bash
gpg --quick-add-key <fingerprint> rsa4096 encr never
gpg --export-secret-key --armor how-to-guide@siderolabs.com > omni.asc
```

<Note>Do not add passphrases to keys during creation.</Note>

### Deploy Omni

First we need to create a namespace for Omni to run in.
```bash
kubectl create namespace omni

# If you are running a Kubernetes version that enforces Pod Security Admission Policies.
# The namespace for Omni must be labeled to allow privileged containers.
kubectl label namespace omni pod-security.kubernetes.io/enforce=privileged
```
Now that we have out namespace created, we need to create a secret with the GPG key we just generated. This will be used by Omni to encrypt data in etcd.

```bash
kubectl create secret generic omni-gpg-key \
  --namespace omni \
  --from-file=omni.asc
```

You can install Omni with Helm, but before we can do that we need to create a values file with the necessary configuration. You can use the following template as a starting point. For the full list of configuration options, please see the [Helm chart documentation](https://github.com/siderolabs/omni/tree/main/deploy/helm/omni).

```yaml
config:
  account:
    # ID is the unique identifier of the Omni account. It can be generated with `uuidgen`.
    id: "063db99b-2c77-4b30-bb17-24bd1707312a"
    name: my-omni
  auth:
    auth0:
      enabled: true
      clientID: <your-auth0-client-id>
      domain: <your-auth0-domain>
    initialUsers:  # Initial users are created on the first startup of Omni. They are created with the "admin" role.
      - initial-user-1@siderolabs.com
  services:
    api:
      advertisedURL: https://omni.siderolabs.com
    kubernetesProxy:
      advertisedURL: https://kubernetes.siderolabs.com
    machineAPI:
      advertisedURL: https://siderolink.siderolabs.com
    siderolink:
      wireGuard:
        # The externally accessible IP:port for WireGuard connections.
        # If using an externally accessible node IP, the port should match
        # service.wireguard.nodePort (default: 30180).
        advertisedEndpoint: "10.10.75.10:30180"
etcdEncryptionKey:
  existingSecret: "omni-gpg-key"

ingress:
  main:
    enabled: true
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
    className: traefik
    host: omni.siderolabs.com
    tls:
      - secretName: omni-tls
        hosts:
          - omni.siderolabs.com
  kubernetesProxy:
    enabled: true
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
    className: traefik
    host: kubernetes.siderolabs.com
    tls:
      - secretName: omni-k8s-tls
        hosts:
          - kubernetes.siderolabs.com
  siderolinkApi:
    enabled: true
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
    className: traefik
    host: siderolink.siderolabs.com
    tls:
      - secretName: omni-siderolink-tls
        hosts:
          - siderolink.siderolabs.com
```

With the values file created, we can now install the Helm chart.

```bash
helm install \
  omni oci://ghcr.io/siderolabs/charts/omni \
  --version v2.1.1 \
  --namespace omni \
  --values values.yaml
``` 

Congratulations! You have now deployed Omni on Kubernetes. You can access the web UI at `https://omni.siderolabs.com`.

### Workload Proxy (Optional)
Workload Proxy allows you to expose HTTP services running in your managed clusters through Omni. Once configured, you can annotate Kubernetes Services to make them accessible, protected by Omni's authentication.

For details on exposing services, see [Expose an HTTP Service from a Cluster](https://docs.siderolabs.com/omni/cluster-management/expose-an-http-service-from-a-cluster).

The workload proxy domain is not a subdomain of Omniâ€”it exists alongside it. For example:
* Omni: omni.siderolabs.com
* Workload Proxy: *.omni-workload.siderolabs.com

To enable the workload proxy, you need to enable the `workloadProxy` component in the Helm chart values and create an additional Ingress resource with the help of extraObjects section.

```yaml
config:
  services:
    workloadProxy:
      enabled: true
      subdomain: omni-workload

extraObjects:
  - apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: omni-workload-proxy
      annotations:
        cert-manager.io/cluster-issuer: letsencrypt
        traefik.ingress.kubernetes.io/service.passhostheader: "true"
        traefik.ingress.kubernetes.io/service.serversscheme: h2c
    spec:
      tls:
        - hosts:
            - omni-workload.siderolabs.com
            - "*.omni-workload.siderolabs.com"
          secretName: omni-workload-proxy-wildcard-tls
      rules:
        - host: "*.omni-workload.siderolabs.com"
          http:
            paths:
              - path: /
                pathType: Prefix
                backend:
                  service:
                    name: omni
                    port:
                      name: omni
```
You can then upgrade the updated Helm chart with this command.

```bash
helm upgrade \
  omni oci://ghcr.io/siderolabs/charts/omni \
  --version v2.1.1 \
  --namespace omni \
  --values values.yaml
```