---
title: "Upgrading Talos Linux"
description: "Guide to upgrading a Talos Linux machine."
aliases:
  - ../guides/upgrading-talos
---

import { release_v1_12 } from '/snippets/custom-variables.mdx';

OS upgrades are effected by an API call, which can be sent via the `talosctl` CLI utility.

The upgrade API call passes a node the installer image to use to perform the upgrade.

Each Talos version has a corresponding installer image, listed on the release page for the version, for example <a href={`https://github.com/siderolabs/talos/releases/tag/${release_v1_12}`}>{release_v1_12}</a>.

Upgrades use an A-B image scheme in order to facilitate rollbacks.
This scheme retains the previous Talos kernel and OS image following each upgrade.
If an upgrade fails to boot, Talos will roll back to the previous version.
Likewise, Talos may be manually rolled back via API (or `talosctl rollback`), which will update the boot reference and reboot.

*Note* An upgrade of the Talos Linux OS will not (since v1.0) apply an upgrade to the Kubernetes version by default.
Kubernetes upgrades should be managed separately per [upgrading kubernetes](../../../../kubernetes-guides/advanced-guides/upgrading-kubernetes).

## Supported upgrade paths

Because Talos Linux is image based, an upgrade is almost the same as installing Talos, with the difference that the system has already been initialized with a configuration.
The supported configuration may change between versions.
The upgrade process should handle such changes transparently, but this migration is only tested between adjacent minor releases.
Thus the recommended upgrade path is to always upgrade to the latest patch release of all intermediate minor releases.

For example, if upgrading from Talos 1.0 to Talos 1.2.4, the recommended upgrade path would be:

* upgrade from 1.0 to latest patch of 1.0 - to v1.0.6
* upgrade from v1.0.6 to latest patch of 1.1 - to v1.1.2
* upgrade from v1.1.2 to v1.2.4

## Before upgrade to {release_v1_12}

There are no specific actions to be taken before an upgrade.

## Video walkthrough

To see a live demo of an upgrade of Talos Linux, see the video below:

<iframe width="560" height="315" src="https://www.youtube.com/embed/AAF6WhX0USo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

## After upgrade to {release_v1_12}

There are no specific actions to be taken after an upgrade.

## `talosctl upgrade`

To upgrade a Talos node, specify the node's IP address and the
installer container image for the version of Talos to upgrade to.

For instance, if your Talos node has the IP address `10.20.30.40` and you want
to install the current version, you would enter a command such
as:

<CodeBlock lang="sh">
{`
  $ talosctl upgrade --nodes 10.20.30.40 \\
  --image ghcr.io/siderolabs/installer:${release_v1_12}
`}
</CodeBlock>

Rarely, an upgrade command will fail due to a process holding a file open on disk.
In these cases, you can use the `--stage` flag.
This puts the upgrade artifacts on disk, and adds some metadata to a disk partition that gets checked very early in the boot process, then reboots the node.
On the reboot, Talos sees that it needs to apply an upgrade, and will do so immediately.
Because this occurs in a just rebooted system, there will be no conflict with any files being held open.
After the upgrade is applied, the node will reboot again, in order to boot into the new version.
Note that because Talos Linux reboots via the `kexec` syscall, the extra reboot adds very little time.

## Machine configuration changes

* [VolumeConfig](../../reference/configuration/block/volumeconfig) now supports encryption configuration for system volumes.
* [VolumeConfig](../../reference/configuration/block/volumeconfig), [UserVolumeConfig](../../reference/configuration/block/uservolumeconfig) encryption configuration for TPM now supports specifying PCRs to lock the encryption key to.
* volume configuration in `.provisioning.maxSize` now supports relative sizes using `%` suffix.
* [UserVolumeConfig](../../reference/configuration/block/uservolumeconfig) now supports `volumeType` field with `partition` (default), `disk` and `directory` values.
* new registry-related configuration documents: [RegistryMirrorConfig](../../reference/configuration/cri/registrymirrorconfig),
  [RegistryAuthConfig](../../reference/configuration/cri/registryauthconfig),
  and [RegistryTLSConfig](../../reference/configuration/cri/registrytlsconfig).
* new network configuration documents:
  * [BondConfig](../../reference/configuration/network/bondconfig)
  * [BridgeConfig](../../reference/configuration/network/bridgeconfig)
  * [DHCPv4Config](../../reference/configuration/network/dhcpv4config)
  * [DHCPv6Config](../../reference/configuration/network/dhcpv6config)
  * [DummyLinkConfig](../../reference/configuration/network/dummylinkconfig)
  * [HCloudVIPConfig](../../reference/configuration/network/hcloudvipconfig)
  * [HostnameConfig](../../reference/configuration/network/hostnameconfig)
  * [Layer2VIPConfig](../../reference/configuration/network/layer2vipconfig)
  * [LinkConfig](../../reference/configuration/network/linkconfig)
  * [LinkAliasConfig](../../reference/configuration/network/linkaliasconfig)
  * [ResolverConfig](../../reference/configuration/network/resolverconfig)
  * [StaticHostConfig](../../reference/configuration/network/statichostconfig)
  * [TimeSyncConfig](../../reference/configuration/network/timesyncconfig)
  * [VLANConfig](../../reference/configuration/network/vlanconfig)
  * [WireguardConfig](../../reference/configuration/network/wireguardconfig)
* [EthernetConfig](../../reference/configuration/network/ethernetconfig) now supports `wakeOnLAN` configuration.
* new document [OOMConfig](../../reference/configuration/runtime/oomconfig) to configure OOM handler.
* deprecated, but still supported fields in `valpha1` config:
  * `.machine.time` (use `TimeSyncConfig` instead)
  * `.machine.registries` (use `RegistryMirrorConfig`, `RegistryAuthConfig`, and `RegistryTLSConfig` instead)
  * `.machine.network.hostname` (use `HostnameConfig` instead)
  * `.machine.network.interfaces` (use `LinkConfig`, `VLANConfig`, `BondConfig`, `BridgeConfig`, etc. instead)
  * `.machine.network.nameservers`, `.machine.network.searchDomains`, `.machine.network.disableSearchDomain` (use `ResolverConfig` instead)
  * `.machine.network.extraHostEntries` (use `StaticHostConfig` instead)
  * `.machine.install.extraKernelArgs` (use Image Factory instead)
* new `v1alpha` config fields:
  * `.machine.install.grubUseUKICmdline` to unify kernel args behavior for legacy GRUB bootloader with systemd-boot.


## Upgrade sequence

When a Talos node receives the upgrade command, it cordons
itself in Kubernetes, to avoid receiving any new workload.
It then starts to drain its existing workload.

**NOTE**: If any of your workloads are sensitive to being shut down ungracefully, be sure to use the `lifecycle.preStop` Pod [spec](https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#container-hooks).

Once all of the workload Pods are drained, Talos will start shutting down its
internal processes.

Once all the processes are stopped and the services are shut down, the filesystems will be unmounted.
This allows Talos to produce a very clean upgrade, as close as possible to a pristine system.
We verify the disk and then perform the actual image upgrade.
We set the bootloader to boot *once* with the new kernel and OS image, then we reboot.

After the node comes back up and Talos verifies itself, it will make
the bootloader change permanent, rejoin the cluster, and finally uncordon itself to receive new workloads.

## FAQs

**Q.** What happens if an upgrade fails?

**A.** Talos Linux attempts to safely handle upgrade failures.

The most common failure is an invalid installer image reference.
In this case, Talos will fail to download the upgraded image and will abort the upgrade.

Sometimes, Talos is unable to successfully kill off all of the disk access points, in which case it cannot safely unmount all filesystems to effect the upgrade.
In this case, it will abort the upgrade and reboot.
(`upgrade --stage` can ensure that upgrades can occur even when the filesytems cannot be unmounted.)

It is possible (especially with test builds) that the upgraded Talos system will fail to start.
In this case, the node will be rebooted, and the bootloader will automatically use the previous Talos kernel and image, thus effectively rolling back the upgrade.

Lastly, it is possible that Talos itself will upgrade successfully, start up, and rejoin the cluster but your workload will fail to run on it, for whatever reason.
This is when you would use the `talosctl rollback` command to revert back to the previous Talos version.

**Q.** Can upgrades be scheduled?

**A.** Because the upgrade sequence is API-driven, you can easily tie it in to your own business logic to schedule and coordinate your upgrades.

**Q.** Can the upgrade process be observed?

**A.** Yes, using the `talosctl dmesg -f` command.
You can also use `talosctl upgrade --wait`, and optionally `talosctl upgrade --wait --debug` to observe kernel logs

**Q.** Are worker node upgrades handled differently from control plane node upgrades?

**A.** Short answer: no.

Long answer:  Both node types follow the same set procedure.
From the user's standpoint, however, the processes are identical.
However, since control plane nodes run additional services, such as etcd, there are some extra steps and checks performed on them.
For instance, Talos will refuse to upgrade a control plane node if that upgrade would cause a loss of quorum for etcd.
If multiple control plane nodes are asked to upgrade at the same time, Talos will protect the Kubernetes cluster by ensuring only one control plane node actively upgrades at any time, via checking etcd quorum.

**Q.** Can I break my cluster by upgrading everything at once?

**A.** Possibly - it's not recommended.

Nothing prevents the user from sending near-simultaneous upgrades to each node of the cluster - and while Talos Linux and Kubernetes can generally deal with this situation, other components of the cluster may not be able to recover from more than one node rebooting at a time.
(e.g. any software that maintains a quorum or state across nodes, such as Rook/Ceph)

**Q.** Which version of `talosctl` should I use to update a cluster?

**A.** We recommend using the version that matches the current running version of the cluster.
